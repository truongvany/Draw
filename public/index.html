<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cùng nhau vẽ Mặt Trăng nè!</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #drawingCanvas {
      border: 1px solid #000;
      background-color: #fff;
      width: 100%;
      max-width: 800px;
      height: auto;
      aspect-ratio: 1;
    }
    .controls {
      margin: 10px 0;
      padding: 10px;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .controls label {
      margin-right: 10px;
    }
    .controls input[type="color"],
    .controls input[type="range"] {
      vertical-align: middle;
    }
    #clear {
      padding: 5px 10px;
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #clear:hover {
      background-color: #cc0000;
    }
  </style>
</head>
<body>
  <h2>🖌️ Cùng nhau vẽ Mặt Trăng nè!</h2>
  <div class="controls">
    Màu: <input type="color" id="color" value="#000000">
    Nét: <input type="range" id="lineWidth" min="1" max="20" value="5">
    <button id="clear">🧽 Xoá bảng</button>
  </div>
  <canvas id="drawingCanvas"></canvas>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const colorInput = document.getElementById('color');
    const lineWidthInput = document.getElementById('lineWidth');
    const socket = io();

    // Đặt kích thước canvas và chuẩn hóa tỷ lệ
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1; // Lấy tỷ lệ pixel của thiết bị
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = canvas.width; // Giữ tỷ lệ 1:1
      ctx.scale(dpr, dpr); // Điều chỉnh tỷ lệ vẽ
      redraw(); // Vẽ lại khi thay đổi kích thước
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let drawing = false;
    let currentX, currentY;
    let canvasRect = canvas.getBoundingClientRect(); // Lấy kích thước canvas

    // Cập nhật kích thước canvas khi thay đổi
    function updateCanvasRect() {
      canvasRect = canvas.getBoundingClientRect();
    }
    window.addEventListener('resize', updateCanvasRect);

    // Sự kiện chuột (máy tính)
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Sự kiện cảm ứng (điện thoại)
    canvas.addEventListener('touchstart', startDrawingTouch, { passive: false });
    canvas.addEventListener('touchmove', drawTouch, { passive: false });
    canvas.addEventListener('touchend', stopDrawingTouch, { passive: false });

    function startDrawing(e) {
      drawing = true;
      updateCanvasRect();
      [currentX, currentY] = [e.clientX - canvasRect.left, e.clientY - canvasRect.top];
    }

    function draw(e) {
      if (!drawing) return;
      const newX = e.clientX - canvasRect.left;
      const newY = e.clientY - canvasRect.top;
      drawLine(currentX, currentY, newX, newY);
      [currentX, currentY] = [newX, newY];
    }

    function stopDrawing() {
      drawing = false;
    }

    // Sự kiện cảm ứng
    function startDrawingTouch(e) {
      e.preventDefault();
      drawing = true;
      updateCanvasRect();
      const touch = e.touches[0];
      [currentX, currentY] = [touch.clientX - canvasRect.left, touch.clientY - canvasRect.top];
    }

    function drawTouch(e) {
      e.preventDefault();
      if (!drawing) return;
      const touch = e.touches[0];
      const newX = touch.clientX - canvasRect.left;
      const newY = touch.clientY - canvasRect.top;
      drawLine(currentX, currentY, newX, newY);
      [currentX, currentY] = [newX, newY];
    }

    function stopDrawingTouch(e) {
      e.preventDefault();
      drawing = false;
    }

    // Hàm vẽ đường thẳng và gửi dữ liệu
    function drawLine(x1, y1, x2, y2) {
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = colorInput.value;
      ctx.lineWidth = lineWidthInput.value;
      ctx.stroke();
      // Gửi tọa độ chuẩn hóa (tỷ lệ 0-1 dựa trên kích thước canvas)
      const normalizedX1 = x1 / canvas.width;
      const normalizedY1 = y1 / canvas.height;
      const normalizedX2 = x2 / canvas.width;
      const normalizedY2 = y2 / canvas.height;
      socket.emit('draw', {
        x1: normalizedX1,
        y1: normalizedY1,
        x2: normalizedX2,
        y2: normalizedY2,
        color: colorInput.value,
        width: lineWidthInput.value
      });
    }

    // Nhận dữ liệu từ server và vẽ
    socket.on('draw', (data) => {
      const x1 = data.x1 * canvas.width;
      const y1 = data.y1 * canvas.height;
      const x2 = data.x2 * canvas.width;
      const y2 = data.y2 * canvas.height;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = data.color;
      ctx.lineWidth = data.width;
      ctx.stroke();
      [currentX, currentY] = [x2, y2];
    });

    // Xóa bảng
    document.getElementById('clear').addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      socket.emit('clear');
    });

    socket.on('clear', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // Hàm vẽ lại khi thay đổi kích thước
    function redraw() {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.putImageData(imageData, 0, 0);
    }
  </script>
</body>
</html>
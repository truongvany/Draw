<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CÃ¹ng nhau váº½ MÄƒÌ£t TrÄƒng neÌ€!</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #drawingCanvas {
      border: 1px solid #000;
      background-color: #fff;
      width: 100%;
      max-width: 800px;
      height: auto;
      aspect-ratio: 1;
    }
    .controls {
      margin: 10px 0;
      padding: 10px;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .controls label {
      margin-right: 10px;
    }
    .controls input[type="color"],
    .controls input[type="range"] {
      vertical-align: middle;
    }
    #clear {
      padding: 5px 10px;
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #clear:hover {
      background-color: #cc0000;
    }
  </style>
</head>
<body>
  <h2>ğŸ–Œï¸ CÃ¹ng nhau váº½ MÄƒÌ£t TrÄƒng nÃ¨!</h2>
  <div class="controls">
    MÃ u: <input type="color" id="color" value="#000000">
    NÃ©t: <input type="range" id="lineWidth" min="1" max="20" value="5">
    <button id="clear">ğŸ§½ XoÃ¡ báº£ng</button>
  </div>
  <canvas id="drawingCanvas"></canvas>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const colorInput = document.getElementById('color');
    const lineWidthInput = document.getElementById('lineWidth');
    const socket = io();

    // Äáº·t kÃ­ch thÆ°á»›c canvas vÃ  chuáº©n hÃ³a tá»· lá»‡
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1; // Láº¥y tá»· lá»‡ pixel cá»§a thiáº¿t bá»‹
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = canvas.width; // Giá»¯ tá»· lá»‡ 1:1
      ctx.scale(dpr, dpr); // Äiá»u chá»‰nh tá»· lá»‡ váº½
      redraw(); // Váº½ láº¡i khi thay Ä‘á»•i kÃ­ch thÆ°á»›c
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let drawing = false;
    let currentX, currentY;
    let canvasRect = canvas.getBoundingClientRect(); // Láº¥y kÃ­ch thÆ°á»›c canvas

    // Cáº­p nháº­t kÃ­ch thÆ°á»›c canvas khi thay Ä‘á»•i
    function updateCanvasRect() {
      canvasRect = canvas.getBoundingClientRect();
    }
    window.addEventListener('resize', updateCanvasRect);

    // Sá»± kiá»‡n chuá»™t (mÃ¡y tÃ­nh)
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Sá»± kiá»‡n cáº£m á»©ng (Ä‘iá»‡n thoáº¡i)
    canvas.addEventListener('touchstart', startDrawingTouch, { passive: false });
    canvas.addEventListener('touchmove', drawTouch, { passive: false });
    canvas.addEventListener('touchend', stopDrawingTouch, { passive: false });

    function startDrawing(e) {
      drawing = true;
      updateCanvasRect();
      [currentX, currentY] = [e.clientX - canvasRect.left, e.clientY - canvasRect.top];
    }

    function draw(e) {
      if (!drawing) return;
      const newX = e.clientX - canvasRect.left;
      const newY = e.clientY - canvasRect.top;
      drawLine(currentX, currentY, newX, newY);
      [currentX, currentY] = [newX, newY];
    }

    function stopDrawing() {
      drawing = false;
    }

    // Sá»± kiá»‡n cáº£m á»©ng
    function startDrawingTouch(e) {
      e.preventDefault();
      drawing = true;
      updateCanvasRect();
      const touch = e.touches[0];
      [currentX, currentY] = [touch.clientX - canvasRect.left, touch.clientY - canvasRect.top];
    }

    function drawTouch(e) {
      e.preventDefault();
      if (!drawing) return;
      const touch = e.touches[0];
      const newX = touch.clientX - canvasRect.left;
      const newY = touch.clientY - canvasRect.top;
      drawLine(currentX, currentY, newX, newY);
      [currentX, currentY] = [newX, newY];
    }

    function stopDrawingTouch(e) {
      e.preventDefault();
      drawing = false;
    }

    // HÃ m váº½ Ä‘Æ°á»ng tháº³ng vÃ  gá»­i dá»¯ liá»‡u
    function drawLine(x1, y1, x2, y2) {
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = colorInput.value;
      ctx.lineWidth = lineWidthInput.value;
      ctx.stroke();
      // Gá»­i tá»a Ä‘á»™ chuáº©n hÃ³a (tá»· lá»‡ 0-1 dá»±a trÃªn kÃ­ch thÆ°á»›c canvas)
      const normalizedX1 = x1 / canvas.width;
      const normalizedY1 = y1 / canvas.height;
      const normalizedX2 = x2 / canvas.width;
      const normalizedY2 = y2 / canvas.height;
      socket.emit('draw', {
        x1: normalizedX1,
        y1: normalizedY1,
        x2: normalizedX2,
        y2: normalizedY2,
        color: colorInput.value,
        width: lineWidthInput.value
      });
    }

    // Nháº­n dá»¯ liá»‡u tá»« server vÃ  váº½
    socket.on('draw', (data) => {
      const x1 = data.x1 * canvas.width;
      const y1 = data.y1 * canvas.height;
      const x2 = data.x2 * canvas.width;
      const y2 = data.y2 * canvas.height;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = data.color;
      ctx.lineWidth = data.width;
      ctx.stroke();
      [currentX, currentY] = [x2, y2];
    });

    // XÃ³a báº£ng
    document.getElementById('clear').addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      socket.emit('clear');
    });

    socket.on('clear', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // HÃ m váº½ láº¡i khi thay Ä‘á»•i kÃ­ch thÆ°á»›c
    function redraw() {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.putImageData(imageData, 0, 0);
    }
  </script>
</body>
</html>